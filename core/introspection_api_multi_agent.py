"""\nExtension for IntrospectionAPI to support Multi-Agent endpoints.\nStage 27: Multi-Agent Communication\n"""\n\nfrom aiohttp import web\nimport json\nimport logging\n\nlog = logging.getLogger("digital_being.introspectionapi")\n\n\ndef add_multi_agent_routes(app: web.Application, components: dict, cors_headers: dict):\n    """Add multi-agent routes to aiohttp application."""\n    \n    async def handle_agents(request: web.Request) -> web.Response:\n        """GET /agents - List all registered agents in the network."""\n        try:\n            coordinator = components.get("multi_agent_coordinator")\n            if coordinator is None:\n                return web.json_response(\n                    {"error": "Multi-agent coordinator not available"},\n                    status=404,\n                    headers=cors_headers\n                )\n            \n            agents = coordinator.list_agents()\n            return web.json_response({"agents": agents, "total": len(agents)}, headers=cors_headers)\n        except Exception as e:\n            log.error(f"handle_agents error: {e}")\n            return web.json_response({"error": str(e)}, status=500, headers=cors_headers)\n    \n    async def handle_send_message(request: web.Request) -> web.Response:\n        """POST /send-message - Send message to agent network."""\n        try:\n            coordinator = components.get("multi_agent_coordinator")\n            if coordinator is None:\n                return web.json_response(\n                    {"error": "Multi-agent coordinator not available"},\n                    status=404,\n                    headers=cors_headers\n                )\n            \n            data = await request.json()\n            to_agent = data.get("to_agent")\n            message_type = data.get("type", "BROADCAST")\n            content = data.get("content", {})\n            \n            if not to_agent and message_type != "BROADCAST":\n                return web.json_response(\n                    {"error": "to_agent required for non-broadcast messages"},\n                    status=400,\n                    headers=cors_headers\n                )\n            \n            # Send message based on type\n            if message_type == "QUERY":\n                question = content.get("question", "")\n                coordinator.send_query(to_agent, question)\n                result = {"status": "sent", "type": "query"}\n            elif message_type == "TASK":\n                task = content.get("task", "")\n                coordinator.delegate_task(task, context=content.get("context", {}))\n                result = {"status": "sent", "type": "task"}\n            elif message_type == "BROADCAST":\n                message = content.get("message", "")\n                coordinator.broadcast(message)\n                result = {"status": "broadcast", "type": "broadcast"}\n            else:\n                return web.json_response(\n                    {"error": f"Unknown message type: {message_type}"},\n                    status=400,\n                    headers=cors_headers\n                )\n            \n            return web.json_response(result, headers=cors_headers)\n        except Exception as e:\n            log.error(f"handle_send_message error: {e}")\n            return web.json_response({"error": str(e)}, status=500, headers=cors_headers)\n    \n    async def handle_agent_stats(request: web.Request) -> web.Response:\n        """GET /agent-stats - Get multi-agent coordinator statistics."""\n        try:\n            coordinator = components.get("multi_agent_coordinator")\n            if coordinator is None:\n                return web.json_response(\n                    {"error": "Multi-agent coordinator not available"},\n                    status=404,\n                    headers=cors_headers\n                )\n            \n            stats = coordinator.get_stats()\n            return web.json_response(stats, headers=cors_headers)\n        except Exception as e:\n            log.error(f"handle_agent_stats error: {e}")\n            return web.json_response({"error": str(e)}, status=500, headers=cors_headers)\n    \n    # Add routes\n    app.router.add_get("/agents", handle_agents)\n    app.router.add_post("/send-message", handle_send_message)\n    app.router.add_get("/agent-stats", handle_agent_stats)\n